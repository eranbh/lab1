#ifndef __MEM_DB_COMMON_INC_SHM_HANDLER_H_
#define __MEM_DB_COMMON_INC_SHM_HANDLER_H_
#include <sys/shm.h> // for shm defs
#include "types.h" // For my types
#include "macros.h"


class mem_allocator
{
private:


  typedef struct tChunkHeader
  {
    unsigned int sz;
    unsigned int actSz;
  }ChunkHeader;


  static const unsigned int SMALL_CHUNK_SZ = 1024;
  static const unsigned int HUGE_CHUNK_SZ  = 4096;


public:

  mem_allocator();

  static mem_allocator& get_alloc()
  {static mem_allocator s_alloc;return s_alloc;}

  // Assumes valid memory
  inline static unsigned int 
  getSz(void* pshm)
  {
    ChunkHeader* phead = 
    __RE_INTPRT_SHM_TO_TYPE(ChunkHeader, pshm);
    return phead->sz;
  }

   inline static unsigned int 
  getActSz(void* pshm)
  {
    ChunkHeader* phead = 
    __RE_INTPRT_SHM_TO_TYPE(ChunkHeader, pshm);
    return phead->actSz;
  }
  
  inline void updateActSize(unsigned int i_sz, void* pshm)
  {
	ChunkHeader* phead =
    __RE_INTPRT_SHM_TO_TYPE(ChunkHeader, pshm);
    phead->actSz+=i_sz;
  } 


  ~mem_allocator(){}


  int initAllocator();
  
  typedef mem_db::Uint32 Pointer;
  static const mem_db::Uint32  NULL_POINTER;


  int disposeChunk(const Pointer i_pointer);

  void* allocSmallChunk(Pointer& o_pointer)
  {return allocChunk(SMALL_CHUNK_SZ, o_pointer);}
  void* allocHugeChunk(Pointer& o_pointer)
  {return allocChunk(HUGE_CHUNK_SZ, o_pointer);}

  static void* pointerToLocalPointer(const Pointer& pointer);

  // This actually:
  // 1. creates a new SHM key
  // 2. Allocates a new [bigger] chunk
  // 3. copies the data on to the allocated mem
  // 4. Changes the db_start shm key with the new one
  void* reAllocSHM(Pointer& pointer);


   void* allocChunk(const unsigned int i_Sz, Pointer& o_pointer);
 private:
  // DB start key.
  key_t m_dbStart;
};



#endif // __MEM_DB_COMMON_INC_SHM_HANDLER_H_
